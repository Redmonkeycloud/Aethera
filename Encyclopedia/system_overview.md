## System Overview

### 1. Problem AETHERA Solves
Environmental Impact Assessments (EIAs) remain manual, inconsistent, and data-fragile. GIS analysts download disparate datasets, consultants perform ad-hoc overlays, and results are copied into narrative reports with little reproducibility. Smaller organizations lack the tooling, and developers fly blind during site selection. AETHERA closes this gap with an AI-assisted platform that automates geospatial screening, legal reasoning, emissions quantification, and draft report generation.

### 2. End-State Capabilities
1. **Input ingestion** – AOI (shapefile, GeoJSON, WKT), project metadata (type, capacity, phasing), baseline parameters.
2. **Automated data preparation** – fetch and cache CORINE, GADM, Natural Earth, Natura, hazard maps, socio-economic layers, emission factors.
3. **AI/ML analysis** – RESM suitability scores, AHSM hazard exposure, CIM cumulative impacts, and a mandatory Biodiversity AI module blending rule-based overlays with ML-based habitat/sensitivity predictions.
4. **Legal reasoning** – country-specific thresholds, buffers, sector logic encoded via rules engine.
5. **Indicators & Emissions** – land cover stats, fragmentation, baseline vs project emissions.
6. **Outputs** – interactive maps, tables, draft EIA chapters, exportable GIS/Excel/PDF packages; drafts feed into a report-learning memory so future runs can adapt to reviewer feedback even though no historical reports exist yet.
7. **Scenario comparison** – multi-route/layout “what-if” exploration with versioned runs.

### 3. Layered Architecture
| Layer | Description | Key Tech |
| --- | --- | --- |
| Data & Ingestion | Dataset catalog, caching, provenance, AOI validation | Python, GDAL, Tippecanoe, MinIO/S3 |
| Geospatial Engine | Overlay/intersection, buffers, zonal stats, tiling | GeoPandas, Rasterio, Pyogrio, Dask-Geopandas |
| AI/ML Engine | RESM, AHSM, CIM, mandatory Biodiversity AI; ensemble selection for best projections | PyTorch, XGBoost, LightGBM, scikit-learn, MLflow/W&B, ensemble orchestrators |
| Legal Rules Engine | YAML/JSON country logic compiled to evaluation graph | Python, jsonlogic, Pydantic |
| Emissions & Indicators | Baseline/project emissions, KPI calculators | Python, Pandas |
| Application Backend | Orchestration, async jobs, API, report-memory storage | FastAPI, Celery, Postgres/PostGIS + pgvector, Redis |
| Web Frontend | Map-centric UX, indicators dashboard | TypeScript, React, MapLibre, Deck.GL |
| Reporting & Learning | Template engine, report feedback memory, embeddings for retrieval | Python, Jinja2, LLM connectors, FAISS/pgvector |
| Logging & Monitoring | Run manifests, metrics, alerting | Python logging, OpenTelemetry, Prometheus/Grafana |

### 4. Data Sets
- **Geospatial context** – Natural Earth, GADM, Eurostat NUTS.
- **Land cover/use** – CORINE (EU) plus regional variants.
- **Protected areas/biodiversity** – Natura 2000, national protected areas, EUNIS habitats, future species models.
- **Hazards** – flood, wildfire, landslide, coastal erosion, climate projections.
- **Socio-economic** – population grids (GHSL/WorldPop), infrastructure, sensitive receptors.
- **Emission factors** – IPCC, EMEP/EEA, project overrides.
- **Project inputs** – AOI geometry, type, capacity, layout assumptions, baseline activity data.

### 5. Core Engines
1. **GIS Handler (`backend/src/main_controller.py`)**
   - Loads and validates AOIs, reprojects to working CRS, performs overlay, clipping, buffering, zonal statistics, and writes processed data.
   - Uses dataset connectors and caching to avoid repeated downloads.
2. **AI/ML Engine (`ai/`)**
   - Config-driven pipelines; each model has YAML config, model definition, training script, evaluation script, and inference interface.
   - Biodiversity analysis begins rule-based but evolves into predictive habitat suitability.
3. **Emissions Engine (`backend/src/emissions/`)**
   - Computes baseline and project-induced emissions across lifecycle phases using activity data and emission factors.
4. **Biodiversity AI (Mandatory)**
   - Starts with overlay + rule-based scoring (protected areas, Natura codes, fragmentation); evolves into ML models predicting habitat sensitivity or species suitability, delivering interpretable outputs that feed directly into CIM and reporting text.
5. **Legal Rules Engine**
   - YAML/JSON definitions per country describing thresholds, buffers, and compliance logic. Evaluates project metrics and emits decision matrices with textual explanations.

### 6. Backend, Learning Memory & Frontend Concept
- **Backend**
  - FastAPI service with endpoints for projects, runs, status, results.
    - `POST /projects`, `GET /projects/{id}` manage lightweight metadata (currently JSON store, later PostgreSQL).
    - `GET /runs` enumerates manifests generated by the pipeline; `GET /runs/{id}` adds biodiversity layer URLs to drive the frontend map.
  - Celery workers pulling from Redis queue execute heavy GIS/AI tasks.
  - Results stored in PostGIS (metadata) and object storage for rasters/exports.
  - Report memory subsystem: `reports_history` table + embeddings index (pgvector/S3) prepared to ingest consultant-reviewed reports once available; retrieval augments template/LLM generation to exceed 80% completeness over time.
  - Biodiversity layers exposed via API endpoints (e.g., `/runs/{id}/biodiversity/sensitivity`) delivering GeoJSON straight to the frontend map.
- **Frontend**
  - React + MapLibre map for AOI upload/drawing, layer control, scenario toggles.
  - Indicator panels, table exports, report preview/download.
  - Auth + workspace features for multi-user collaboration (later phase).

### 7. Logging & Reproducibility
- Central logging utility writes per-step logs with timing and memory usage.
- Each run creates:
  - `run_<timestamp>.log`
  - Config snapshot (datasets, versions, hyperparameters)
  - Manifest listing all outputs (maps, tables, report)
- Supports auditing and regulator-ready traceability.

### 8. Language Mix Rationale
- **Python** – primary language for backend, GIS, AI (including biodiversity), rules, and report generation.
- **TypeScript** – modern frontend development for map-heavy UX.
- **SQL (PostgreSQL/PostGIS + pgvector)** – spatial database, metadata persistence, and retrieval-augmented report memory. Docker compose configuration ships with PostGIS + pgvector so developers can spin up the stack locally via `docker compose up -d db`.
- **Optional (future)** – Go/Rust for high-performance raster tiling services; R for specialized statistical annexes if needed.

### 9. External Biodiversity Sources
- **Natura 2000 (EEA)** – authoritative EU protected areas dataset used for overlap metrics and training pipeline.
- **CORINE Land Cover 2018 (Copernicus)** – baseline land cover data for forest ratios and suitability features.
- **Our World in Data – Biodiversity habitat loss (Williams et al. 2021)** – global country-level indicators fetched automatically via `scripts/fetch_external_biodiversity_sources.py`.
- **GBIF Occurrence API** – on-demand species occurrence samples (e.g., Italian raptors) downloaded for enrichment and validation.

This document captures the core product definition and architecture blueprint that guides the implementation plan.

